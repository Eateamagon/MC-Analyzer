<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <?!= include('Styles'); ?>
  <style>
    /* Upload-specific styles */
    .upload-zone {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 60px 40px;
      text-align: center;
      transition: all var(--transition-normal);
      cursor: pointer;
      background: var(--bg-surface-light);
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--primary);
      background: rgba(124, 58, 237, 0.1);
    }
    
    .upload-zone .material-icons {
      font-size: 64px;
      color: var(--primary);
      margin-bottom: 16px;
    }
    
    .upload-zone h3 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    
    .upload-zone p {
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    .file-info {
      display: none;
      background: var(--bg-surface);
      border-radius: var(--border-radius-sm);
      padding: 16px 20px;
      margin-top: 20px;
      align-items: center;
      gap: 16px;
    }
    
    .file-info.active {
      display: flex;
    }
    
    .file-icon {
      width: 48px;
      height: 48px;
      background: rgba(124, 58, 237, 0.15);
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }
    
    .file-details {
      flex: 1;
    }
    
    .file-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .file-size {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .file-remove {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all var(--transition-fast);
    }
    
    .file-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      color: var(--color-error);
    }
    
    .metadata-form {
      display: none;
      margin-top: 24px;
    }
    
    .metadata-form.active {
      display: block;
    }
    
    .metadata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-surface-light);
    }
    
    .step.active {
      background: var(--primary);
      color: white;
    }
    
    .step.completed {
      background: rgba(16, 185, 129, 0.2);
      color: var(--color-strength);
    }
    
    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .step.active .step-number {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .step.completed .step-number {
      background: var(--color-strength);
      color: white;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
    }
    
    .periods-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .periods-table th,
    .periods-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .periods-table th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .periods-table input {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-surface-light);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius-sm);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .periods-table input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .teacher-group {
      margin-bottom: 24px;
    }
    
    .teacher-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-hover);
      border-radius: var(--border-radius-sm);
      margin-bottom: 8px;
      cursor: pointer;
    }
    
    .teacher-header:hover {
      background: rgba(124, 58, 237, 0.1);
    }
    
    .teacher-header .material-icons {
      color: var(--primary);
    }
    
    .teacher-name {
      font-weight: 500;
    }
    
    .teacher-count {
      margin-left: auto;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .bulk-period-input {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg-surface);
      border-radius: var(--border-radius-sm);
      margin-bottom: 16px;
    }
    
    .bulk-period-input input {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">üèõÔ∏è</span>
        <span class="logo-text">KCMS Analyzer</span>
      </div>
    </div>
    
    <div class="nav-section">
      <div class="nav-label">MAIN</div>
      <a href="<?= scriptUrl ?>?page=dashboard" class="nav-item">
        <span class="material-icons">dashboard</span>
        <span>Dashboard</span>
      </a>
      <a href="<?= scriptUrl ?>?page=upload" class="nav-item active">
        <span class="material-icons">cloud_upload</span>
        <span>Upload Data</span>
      </a>
      <a href="<?= scriptUrl ?>?page=compare" class="nav-item">
        <span class="material-icons">compare_arrows</span>
        <span>Compare</span>
      </a>
      <a href="<?= scriptUrl ?>?page=history" class="nav-item">
        <span class="material-icons">history</span>
        <span>Assessment History</span>
      </a>
    </div>

    <? if (user.role !== 'teacher') { ?>
    <div class="nav-section">
      <div class="nav-label">ADMIN</div>
      <a href="<?= scriptUrl ?>?page=admin" class="nav-item">
        <span class="material-icons">admin_panel_settings</span>
        <span>Admin Panel</span>
      </a>
      <a href="javascript:void(0)" class="nav-item" onclick="showDistrictSummary()">
        <span class="material-icons">assessment</span>
        <span>District Summary</span>
      </a>
    </div>
    <? } ?>

    <div class="nav-section">
      <div class="nav-label">SETTINGS</div>
      <a href="javascript:void(0)" class="nav-item" onclick="openSettings()">
        <span class="material-icons">tune</span>
        <span>Preferences</span>
      </a>
    </div>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar"><?= user.name ? user.name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase() ?></div>
        <div class="user-details">
          <div class="user-name"><?= user.name || user.email.split('@')[0] ?></div>
          <div class="user-role"><?= user.role === 'division_admin' ? 'Division Admin' : user.role === 'school_admin' ? 'School Admin' : 'Teacher' ?></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <header class="top-header">
      <div class="header-left">
        <h1>Upload Assessment Data</h1>
        <span class="header-subtitle">Import your assessment data (Mastery Connect or SOL format)</span>
      </div>
      <div class="header-right" style="display:flex;align-items:center;gap:16px;">
        <div class="theme-toggles">
          <div class="toggle-group">
            <span class="material-icons toggle-icon">light_mode</span>
            <label class="toggle-switch"><input type="checkbox" id="themeToggle" onchange="toggleTheme()"><span class="toggle-slider"></span></label>
            <span class="toggle-label">Light</span>
          </div>
          <div class="toggle-group">
            <span class="material-icons toggle-icon">visibility</span>
            <label class="toggle-switch"><input type="checkbox" id="colorblindToggle" onchange="toggleColorblind()"><span class="toggle-slider"></span></label>
            <span class="toggle-label">Colorblind</span>
          </div>
        </div>
      </div>
    </header>

    <div class="dashboard-content">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1Indicator">
          <div class="step-number">1</div>
          <span>Upload File</span>
        </div>
        <div class="step" id="step2Indicator">
          <div class="step-number">2</div>
          <span>Add Details</span>
        </div>
        <div class="step" id="step3Indicator">
          <div class="step-number">3</div>
          <span>Class Periods</span>
        </div>
      </div>

      <!-- Step 1: Upload -->
      <div class="card step-content active" id="step1Content">
        <div class="card-header">
          <h2 class="card-title">
            <span class="material-icons">upload_file</span>
            Upload CSV File
          </h2>
        </div>
        <div class="card-body">
          <div class="upload-zone" id="uploadZone">
            <span class="material-icons">cloud_upload</span>
            <h3>Drop your CSV file here</h3>
            <p>or click to browse files</p>
            <input type="file" id="fileInput" accept=".csv,.tsv,.txt" style="display: none;">
            <button class="btn btn-secondary">Browse Files</button>
          </div>
          
          <div class="file-info" id="fileInfo">
            <div class="file-icon">
              <span class="material-icons">description</span>
            </div>
            <div class="file-details">
              <div class="file-name" id="fileName"></div>
              <div class="file-size" id="fileSize"></div>
            </div>
            <button class="file-remove" onclick="removeFile()">
              <span class="material-icons">close</span>
            </button>
          </div>
          
          <!-- Data Format Selector -->
          <div class="form-group" id="formatSelector" style="margin-top: 20px; display: none;">
            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Data Format</label>
            <select id="dataFormat" class="form-input" onchange="onFormatChange()">
              <option value="mastery_connect">Mastery Connect CSV</option>
              <option value="sol_with_sol">SOL Data (With SOL Column)</option>
              <option value="sol_without_sol">SOL Data (Without SOL Column)</option>
            </select>
            <div id="formatHint" style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">Standard Mastery Connect benchmark export</div>
          </div>

          <!-- Existing Assessments Section -->
          <div id="existingAssessmentsSection" style="margin-top: 24px; display: none;">
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
              <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span class="material-icons" style="color: var(--primary);">history</span>
                Your Recent Assessments
              </h4>
              <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
                You've already uploaded these assessments. Click to view their analysis:
              </p>
              <div id="existingAssessmentsList"></div>
            </div>
          </div>
          
          <div style="margin-top: 24px; text-align: right;">
            <button class="btn btn-primary" id="step1Next" onclick="goToStep(2)" disabled>
              Continue
              <span class="material-icons">arrow_forward</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Metadata -->
      <div class="card step-content" id="step2Content">
        <div class="card-header">
          <h2 class="card-title">
            <span class="material-icons">info</span>
            Assessment Details
          </h2>
        </div>
        <div class="card-body">
          <div class="metadata-grid">
            <div class="form-group">
              <label>Assessment Name *</label>
              <input type="text" id="assessmentName" class="form-input" placeholder="e.g., Q2 Math Benchmark">
            </div>
            <div class="form-group">
              <label>Subject</label>
              <select id="assessmentSubject" class="form-input">
                <option value="">Select subject...</option>
                <option value="Math">Math</option>
                <option value="English">English/Language Arts</option>
                <option value="Science">Science</option>
                <option value="Civics">Civics/Social Studies</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Grade Level</label>
              <select id="gradeLevel" class="form-input">
                <option value="">Select grade...</option>
                <option value="K">Kindergarten</option>
                <option value="1">1st Grade</option>
                <option value="2">2nd Grade</option>
                <option value="3">3rd Grade</option>
                <option value="4">4th Grade</option>
                <option value="5">5th Grade</option>
                <option value="6">6th Grade</option>
                <option value="7">7th Grade</option>
                <option value="8">8th Grade</option>
                <option value="9">9th Grade</option>
                <option value="10">10th Grade</option>
                <option value="11">11th Grade</option>
                <option value="12">12th Grade</option>
              </select>
            </div>
            <div class="form-group">
              <label>Assessment Type</label>
              <select id="assessmentType" class="form-input">
                <option value="">Select type...</option>
                <option value="Benchmark Q1">Benchmark Q1</option>
                <option value="Benchmark Q2">Benchmark Q2</option>
                <option value="Benchmark Q3">Benchmark Q3</option>
                <option value="Benchmark Q4">Benchmark Q4</option>
                <option value="Formative">Formative Assessment</option>
                <option value="Summative">Summative Assessment</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date Administered</label>
              <input type="date" id="dateAdministered" class="form-input">
            </div>
            <div class="form-group">
              <label>School</label>
              <select id="assessmentSchool" class="form-input">
                <option value="">Select school...</option>
                <? config.schools.forEach(function(school) { ?>
                  <option value="<?= school ?>" <?= school === user.school ? 'selected' : '' ?>><?= school ?></option>
                <? }); ?>
              </select>
            </div>
          </div>
          
          <div style="margin-top: 24px; display: flex; justify-content: space-between;">
            <button class="btn btn-ghost" onclick="goToStep(1)">
              <span class="material-icons">arrow_back</span>
              Back
            </button>
            <button class="btn btn-primary" onclick="uploadAndContinue()">
              Upload & Continue
              <span class="material-icons">arrow_forward</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Class Periods -->
      <div class="card step-content" id="step3Content">
        <div class="card-header">
          <h2 class="card-title">
            <span class="material-icons">schedule</span>
            Assign Class Periods
          </h2>
        </div>
        <div class="card-body">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <p style="color: var(--text-muted); margin: 0;">
              Assign class periods to students for accurate small group organization.
            </p>
            <div style="display: flex; gap: 8px; flex-shrink: 0;">
              <button class="btn btn-ghost" onclick="skipPeriods()">
                Skip for Now
              </button>
              <button class="btn btn-primary" onclick="savePeriods()">
                Save & Run Analysis
                <span class="material-icons">analytics</span>
              </button>
            </div>
          </div>

          <div class="bulk-period-input">
            <input type="text" id="bulkPeriodValue" class="form-input" placeholder="Enter period (e.g., Period 1, Block A)">
            <button class="btn btn-secondary" onclick="applyBulkPeriod()">
              Apply to Selected
            </button>
            <button class="btn btn-ghost" onclick="selectAll()">
              Select All
            </button>
          </div>

          <div id="periodsList">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" onclick="closeSettings()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3>Analysis Thresholds</h3>
          <div class="form-group">
            <label>Growth Threshold (%)</label>
            <input type="number" id="settingGrowth" class="form-input" min="0" max="100" value="50">
            <span class="form-hint">Scores below this are marked as "Needs Growth"</span>
          </div>
          <div class="form-group">
            <label>Strength Threshold (%)</label>
            <input type="number" id="settingStrength" class="form-input" min="0" max="100" value="75">
            <span class="form-hint">Scores at or above this are marked as "Strength"</span>
          </div>
        </div>
        <div class="settings-section">
          <h3>Small Group Settings</h3>
          <div class="form-group">
            <label>Weakness Threshold (%)</label>
            <input type="number" id="settingSgThreshold" class="form-input" min="0" max="100" value="70">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Min Group Size</label>
              <input type="number" id="settingSgMin" class="form-input" min="1" max="10" value="2">
            </div>
            <div class="form-group">
              <label>Max Group Size</label>
              <input type="number" id="settingSgMax" class="form-input" min="1" max="20" value="5">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <?!= include('Scripts'); ?>

  <script>
    // Base URL for navigation
    const SCRIPT_URL = '<?= scriptUrl ?>';
    
    let uploadedFile = null;
    let csvContent = null;
    let currentAssessmentId = null;
    let studentsList = [];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupUploadZone();
      loadExistingAssessments();
    });
    
    function loadExistingAssessments() {
      google.script.run
        .withSuccessHandler(function(assessments) {
          if (assessments && assessments.length > 0) {
            const section = document.getElementById('existingAssessmentsSection');
            const list = document.getElementById('existingAssessmentsList');
            
            section.style.display = 'block';
            
            list.innerHTML = assessments.slice(0, 5).map(a => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-surface-light); border-radius: 6px; margin-bottom: 8px; cursor: pointer;" 
                   onclick="window.location.href=SCRIPT_URL+'?page=analysis&id=${a.id}'">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span class="material-icons" style="color: var(--primary); font-size: 18px;">description</span>
                  <div>
                    <div style="font-weight: 500; font-size: 14px;">${a.name || 'Unnamed'}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">
                      ${a.subject || 'No subject'} ‚Ä¢ ${a.studentCount || 0} students ‚Ä¢ ${formatDate(a.dateUploaded)}
                    </div>
                  </div>
                </div>
                <span class="material-icons" style="color: var(--text-muted);">chevron_right</span>
              </div>
            `).join('');
          }
        })
        .withFailureHandler(function(error) {
          console.log('Could not load existing assessments:', error);
        })
        .getUserExistingAssessments();
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown date';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function setupUploadZone() {
      const zone = document.getElementById('uploadZone');
      const input = document.getElementById('fileInput');
      
      zone.addEventListener('click', () => input.click());
      
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file && (file.name.endsWith('.csv') || file.name.endsWith('.tsv') || file.name.endsWith('.txt'))) {
          handleFile(file);
        } else {
          showToast('Please upload a CSV, TSV, or TXT file', 'error');
        }
      });
      
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });
    }
    
    function handleFile(file) {
      uploadedFile = file;

      const reader = new FileReader();
      reader.onload = (e) => {
        csvContent = e.target.result;

        // Display file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileInfo').classList.add('active');
        document.getElementById('step1Next').disabled = false;

        // Try to detect assessment name from file
        const baseName = file.name.replace(/\.(csv|tsv|txt)$/i, '').replace(/_/g, ' ');
        document.getElementById('assessmentName').value = baseName;

        // Show format selector and auto-detect format
        document.getElementById('formatSelector').style.display = 'block';
        autoDetectFormat(csvContent);

        // Auto-detect metadata from filename and CSV
        autoDetectMetadata(baseName, csvContent);

        showToast('File loaded successfully!', 'success');
      };

      reader.onerror = () => {
        showToast('Error reading file', 'error');
      };

      reader.readAsText(file);
    }

    function autoDetectMetadata(name, csv) {
      var text = name.toLowerCase();

      // Detect subject
      var subjectMap = {
        'math': 'Math',
        'algebra': 'Math',
        'geometry': 'Math',
        'ela': 'English',
        'english': 'English',
        'language arts': 'English',
        'reading': 'English',
        'writing': 'English',
        'science': 'Science',
        'biology': 'Science',
        'chemistry': 'Science',
        'physics': 'Science',
        'civics': 'Civics',
        'social studies': 'Civics',
        'history': 'Civics',
        'government': 'Civics'
      };
      var subjectEl = document.getElementById('assessmentSubject');
      if (!subjectEl.value) {
        for (var key in subjectMap) {
          if (text.indexOf(key) !== -1) {
            subjectEl.value = subjectMap[key];
            break;
          }
        }
      }

      // Detect grade level
      var gradeEl = document.getElementById('gradeLevel');
      if (!gradeEl.value) {
        var gradeMatch = text.match(/(?:grade|gr\.?)\s*(\d{1,2})/i) ||
                         text.match(/(\d{1,2})(?:st|nd|rd|th)\s*grade/i) ||
                         text.match(/\b([6-8])\s*(?:math|ela|english|science|civics)/i);
        if (gradeMatch) {
          var g = parseInt(gradeMatch[1], 10);
          if (g >= 1 && g <= 12) gradeEl.value = String(g);
        }
      }

      // Detect benchmark type (Q1-Q4, Formative, Summative)
      var typeEl = document.getElementById('assessmentType');
      if (!typeEl.value) {
        var qMatch = text.match(/\bq([1-4])\b/) || text.match(/\bquarter\s*([1-4])\b/) ||
                     text.match(/\bbenchmark\s*q([1-4])\b/) || text.match(/\bq([1-4])\s*benchmark\b/);
        if (qMatch) {
          typeEl.value = 'Benchmark Q' + qMatch[1];
        } else if (/\bformative\b/.test(text)) {
          typeEl.value = 'Formative';
        } else if (/\bsummative\b/.test(text)) {
          typeEl.value = 'Summative';
        }
      }

      // Detect date from filename (patterns: 2025-01-15, 01/15/2025, Jan 2025, etc.)
      var dateEl = document.getElementById('dateAdministered');
      if (!dateEl.value) {
        // Try ISO-ish: 2025-01-15 or 20250115
        var isoMatch = text.match(/\b(20\d{2})[-\/](\d{1,2})[-\/](\d{1,2})\b/);
        if (isoMatch) {
          dateEl.value = isoMatch[1] + '-' + isoMatch[2].padStart(2, '0') + '-' + isoMatch[3].padStart(2, '0');
        } else {
          // Try US format: 01/15/2025 or 1-15-2025
          var usMatch = text.match(/\b(\d{1,2})[-\/](\d{1,2})[-\/](20\d{2})\b/);
          if (usMatch) {
            dateEl.value = usMatch[3] + '-' + usMatch[1].padStart(2, '0') + '-' + usMatch[2].padStart(2, '0');
          }
        }
      }

      // If still no date, try to find one in the first few rows of CSV
      if (!dateEl.value && csv) {
        var lines = csv.split('\n').slice(0, 5).join(' ').toLowerCase();
        var csvDateMatch = lines.match(/\b(20\d{2})[-\/](\d{1,2})[-\/](\d{1,2})\b/);
        if (csvDateMatch) {
          dateEl.value = csvDateMatch[1] + '-' + csvDateMatch[2].padStart(2, '0') + '-' + csvDateMatch[3].padStart(2, '0');
        }
      }
    }
    
    function autoDetectFormat(content) {
      var formatEl = document.getElementById('dataFormat');
      var hintEl = document.getElementById('formatHint');
      if (!content) return;

      // Get first line and normalize to lowercase for matching
      var firstLine = content.split('\n')[0].toLowerCase();

      if (firstLine.indexOf('student name') !== -1 && firstLine.indexOf('delivery group') !== -1 && firstLine.indexOf('correct/incorrect') !== -1) {
        // SOL format detected
        if (firstLine.indexOf('\tsol\t') !== -1 || firstLine.match(/\bsol\b/) && firstLine.indexOf('performance level') !== -1) {
          formatEl.value = 'sol_with_sol';
          hintEl.textContent = 'Auto-detected: SOL format with SOL column';
        } else {
          formatEl.value = 'sol_without_sol';
          hintEl.textContent = 'Auto-detected: SOL format without SOL column';
        }

        // Also try to auto-detect subject and grade from CSV data for SOL formats
        autoDetectSOLMetadata(content);
      } else {
        formatEl.value = 'mastery_connect';
        hintEl.textContent = 'Auto-detected: Standard Mastery Connect benchmark export';
      }
    }

    function autoDetectSOLMetadata(content) {
      // For SOL formats, try to extract subject and grade from the data rows
      var lines = content.split('\n');
      if (lines.length < 2) return;

      // Parse the header to find Subject and Grade columns
      var delimiter = (lines[0].split('\t').length > lines[0].split(',').length) ? '\t' : ',';
      var headers = lines[0].split(delimiter).map(function(h) { return h.trim().toLowerCase(); });
      var subjectIdx = headers.indexOf('subject');
      var gradeIdx = headers.indexOf('grade');

      if (lines.length > 1) {
        var dataFields = lines[1].split(delimiter).map(function(f) { return f.trim(); });

        // Detect subject from data
        if (subjectIdx !== -1 && dataFields[subjectIdx]) {
          var subjectText = dataFields[subjectIdx].toLowerCase();
          var subjectEl = document.getElementById('assessmentSubject');
          if (!subjectEl.value) {
            if (subjectText.indexOf('math') !== -1 || subjectText.indexOf('algebra') !== -1) subjectEl.value = 'Math';
            else if (subjectText.indexOf('science') !== -1) subjectEl.value = 'Science';
            else if (subjectText.indexOf('english') !== -1 || subjectText.indexOf('ela') !== -1 || subjectText.indexOf('reading') !== -1) subjectEl.value = 'English';
            else if (subjectText.indexOf('civics') !== -1 || subjectText.indexOf('history') !== -1 || subjectText.indexOf('government') !== -1) subjectEl.value = 'Civics';
          }
        }

        // Detect grade from data
        if (gradeIdx !== -1 && dataFields[gradeIdx]) {
          var gradeEl = document.getElementById('gradeLevel');
          if (!gradeEl.value) {
            var g = parseInt(dataFields[gradeIdx], 10);
            if (g >= 1 && g <= 12) gradeEl.value = String(g);
          }
        }
      }
    }

    function onFormatChange() {
      var format = document.getElementById('dataFormat').value;
      var hintEl = document.getElementById('formatHint');
      var hints = {
        'mastery_connect': 'Standard Mastery Connect benchmark export with answer choices',
        'sol_with_sol': 'SOL test data with individual SOL codes per item',
        'sol_without_sol': 'SOL test data grouped by Reporting Category (no individual SOL codes)'
      };
      hintEl.textContent = hints[format] || '';
    }

    function removeFile() {
      uploadedFile = null;
      csvContent = null;
      document.getElementById('fileInfo').classList.remove('active');
      document.getElementById('step1Next').disabled = true;
      document.getElementById('fileInput').value = '';
      document.getElementById('formatSelector').style.display = 'none';
    }
    
    function goToStep(step) {
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step${i}Indicator`);
        const content = document.getElementById(`step${i}Content`);
        
        indicator.classList.remove('active', 'completed');
        content.classList.remove('active');
        
        if (i < step) {
          indicator.classList.add('completed');
        } else if (i === step) {
          indicator.classList.add('active');
          content.classList.add('active');
        }
      }
    }
    
    function uploadAndContinue() {
      const name = document.getElementById('assessmentName').value.trim();
      if (!name) {
        showToast('Please enter an assessment name', 'error');
        return;
      }

      // Find and disable the upload button
      var btn = document.querySelector('#step2Content .btn-primary') || event.target.closest('.btn');
      var restore = btn ? setBtnLoading(btn, 'Uploading...') : function(){};

      // Show full-page loading with progress message for large files
      showLoading('Uploading assessment data...');
      var progressNote = document.querySelector('#loadingOverlay .loading-message');
      if (progressNote) {
        progressNote.innerHTML = 'Uploading assessment data...<br><small style="opacity:0.7;">Large files may take a few minutes. Please do not close this tab.</small>';
      }

      const metadata = {
        name: name,
        subject: document.getElementById('assessmentSubject').value,
        gradeLevel: document.getElementById('gradeLevel').value,
        assessmentType: document.getElementById('assessmentType').value,
        dateAdministered: document.getElementById('dateAdministered').value,
        school: document.getElementById('assessmentSchool').value,
        dataFormat: document.getElementById('dataFormat').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          restore();

          // Check if this is a duplicate
          if (result.isDuplicate) {
            showDuplicateDialog(result);
            return;
          }

          if (!result.success) {
            showToast(result.message || 'Upload failed', 'error');
            return;
          }

          currentAssessmentId = result.assessmentId;
          studentsList = result.students;

          showToast('Uploaded ' + result.studentCount + ' students with ' + result.questionCount + ' questions. Running analysis...', 'success');

          // Auto-run analysis immediately after upload
          autoRunAnalysis(currentAssessmentId);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          restore();

          // If upload timed out but may have succeeded, check for it
          var errMsg = error.message || '';
          if (errMsg.indexOf('ScriptError') !== -1 || errMsg.indexOf('timed out') !== -1 || errMsg === '') {
            showUploadRetryDialog(metadata.name);
          } else {
            showToast('Upload failed: ' + errMsg, 'error');
          }
        })
        .processCSVUpload({
          csvContent: csvContent,
          metadata: metadata
        });
    }

    function showUploadRetryDialog(assessmentName) {
      var modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'retryModal';
      modal.innerHTML =
        '<div class="modal-content" style="max-width: 450px;">' +
          '<div class="modal-header">' +
            '<h2><span class="material-icons" style="color: var(--color-monitor); vertical-align: middle;">hourglass_top</span> Upload May Have Completed</h2>' +
          '</div>' +
          '<div class="modal-body">' +
            '<p>The upload took longer than expected. It may have completed successfully in the background.</p>' +
            '<p style="margin-top: 12px; color: var(--text-muted);">Check your Assessment History to see if <strong>' + assessmentName + '</strong> appears.</p>' +
          '</div>' +
          '<div class="modal-footer">' +
            '<button class="btn btn-ghost" onclick="document.getElementById(\'retryModal\').remove()">Dismiss</button>' +
            '<button class="btn btn-primary" onclick="window.location.href=SCRIPT_URL+\'?page=history\'">Check History</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }
    
    function showDuplicateDialog(result) {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'duplicateModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
            <h2><span class="material-icons" style="color: var(--color-monitor); vertical-align: middle;">warning</span> Duplicate Found</h2>
          </div>
          <div class="modal-body">
            <p>${result.message}</p>
            <p style="margin-top: 12px; color: var(--text-muted);">Would you like to view the existing analysis or upload anyway?</p>
          </div>
          <div class="modal-footer" style="flex-wrap: wrap; gap: 8px;">
            <button class="btn btn-ghost" onclick="closeDuplicateDialog()">Cancel</button>
            <button class="btn btn-secondary" onclick="forceUpload()">Upload Anyway</button>
            <button class="btn btn-primary" onclick="viewExistingAnalysis('${result.existingId}')">
              <span class="material-icons">analytics</span>
              View Existing
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function closeDuplicateDialog() {
      const modal = document.getElementById('duplicateModal');
      if (modal) modal.remove();
    }
    
    function viewExistingAnalysis(id) {
      window.location.href = SCRIPT_URL + '?page=analysis&id=' + id;
    }
    
    function forceUpload() {
      closeDuplicateDialog();
      
      // Modify the assessment name to make it unique
      const nameInput = document.getElementById('assessmentName');
      const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      nameInput.value = nameInput.value + ' (' + timestamp + ')';
      
      // Re-run upload
      uploadAndContinue();
    }
    
    function buildPeriodsList() {
      const container = document.getElementById('periodsList');
      
      // Group by teacher
      const byTeacher = {};
      studentsList.forEach(s => {
        if (!byTeacher[s.teacher]) byTeacher[s.teacher] = [];
        byTeacher[s.teacher].push(s);
      });
      
      let html = '';
      Object.keys(byTeacher).sort().forEach(teacher => {
        const students = byTeacher[teacher];
        html += `
          <div class="teacher-group">
            <div class="teacher-header" onclick="toggleTeacher(this)">
              <span class="material-icons">person</span>
              <span class="teacher-name">${teacher}</span>
              <span class="teacher-count">${students.length} students</span>
              <span class="material-icons" style="margin-left: auto;">expand_more</span>
            </div>
            <div class="teacher-students">
              <table class="periods-table">
                <thead>
                  <tr>
                    <th style="width: 40px;"><input type="checkbox" onchange="toggleTeacherCheckboxes(this, '${teacher}')"></th>
                    <th>Student</th>
                    <th style="width: 150px;">Class Period</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        students.forEach(s => {
          html += `
                  <tr>
                    <td><input type="checkbox" class="student-checkbox" data-teacher="${teacher}" data-id="${s.studentId}"></td>
                    <td>${s.studentName}</td>
                    <td>
                      <input type="text" 
                             class="period-input" 
                             data-id="${s.studentId}" 
                             value="${s.period || ''}" 
                             placeholder="Enter period">
                    </td>
                  </tr>
          `;
        });
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function toggleTeacher(header) {
      const students = header.nextElementSibling;
      const icon = header.querySelector('.material-icons:last-child');
      
      if (students.style.display === 'none') {
        students.style.display = 'block';
        icon.textContent = 'expand_more';
      } else {
        students.style.display = 'none';
        icon.textContent = 'expand_less';
      }
    }
    
    function toggleTeacherCheckboxes(masterCheckbox, teacher) {
      const checkboxes = document.querySelectorAll(`.student-checkbox[data-teacher="${teacher}"]`);
      checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
    
    function selectAll() {
      const checkboxes = document.querySelectorAll('.student-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
    }
    
    function applyBulkPeriod() {
      const value = document.getElementById('bulkPeriodValue').value.trim();
      if (!value) {
        showToast('Enter a period value first', 'warning');
        return;
      }
      
      const checked = document.querySelectorAll('.student-checkbox:checked');
      if (checked.length === 0) {
        showToast('Select students first', 'warning');
        return;
      }
      
      checked.forEach(cb => {
        const id = cb.dataset.id;
        const input = document.querySelector(`.period-input[data-id="${id}"]`);
        if (input) input.value = value;
      });
      
      showToast(`Applied "${value}" to ${checked.length} students`, 'success');
    }
    
    function collectPeriodData() {
      const inputs = document.querySelectorAll('.period-input');
      const data = [];
      
      inputs.forEach(input => {
        data.push({
          studentId: input.dataset.id,
          period: input.value.trim()
        });
      });
      
      return data;
    }
    
    function skipPeriods() {
      showConfirm(
        'Skip Class Periods?',
        'You can add class periods later. Small groups will use "Unknown" for period assignments.',
        () => {
          window.location.href = SCRIPT_URL + '?page=analysis&id=' + currentAssessmentId;
        }
      );
    }
    
    function autoRunAnalysis(assessmentId) {
      showLoading('Running analysis...');
      var progressNote = document.querySelector('#loadingOverlay .loading-message');
      if (progressNote) {
        progressNote.innerHTML = 'Analyzing assessment data...<br><small style="opacity:0.7;">This may take a moment for large datasets.</small>';
      }

      var options = {
        itemAnalysis: true,
        smallGroups: true,
        heatmaps: true,
        sendEmail: false
      };

      google.script.run
        .withSuccessHandler(function() {
          hideLoading();
          showToast('Analysis complete! Redirecting...', 'success');
          window.location.href = SCRIPT_URL + '?page=analysis&id=' + assessmentId;
        })
        .withFailureHandler(function(error) {
          hideLoading();
          // Analysis failed but upload succeeded ‚Äî still go to analysis page
          console.log('Auto-analysis error:', error.message);
          showToast('Upload complete. Analysis can be run from the results page.', 'info');
          setTimeout(function() {
            window.location.href = SCRIPT_URL + '?page=analysis&id=' + assessmentId;
          }, 1500);
        })
        .runAnalysis(assessmentId, options);
    }

    // ‚îÄ‚îÄ Settings & District Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
      var user = <?= JSON.stringify(user) ?>;
      if (user.settings) {
        document.getElementById('settingGrowth').value = user.settings.growth || 50;
        document.getElementById('settingStrength').value = user.settings.strength || 75;
        document.getElementById('settingSgThreshold').value = user.settings.sgThreshold || 70;
        document.getElementById('settingSgMin').value = user.settings.sgMin || 2;
        document.getElementById('settingSgMax').value = user.settings.sgMax || 5;
      }
    }
    function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
    function saveSettings() {
      var settings = {
        growth: parseInt(document.getElementById('settingGrowth').value),
        strength: parseInt(document.getElementById('settingStrength').value),
        sgThreshold: parseInt(document.getElementById('settingSgThreshold').value),
        sgMin: parseInt(document.getElementById('settingSgMin').value),
        sgMax: parseInt(document.getElementById('settingSgMax').value)
      };
      google.script.run
        .withSuccessHandler(function() { showToast('Settings saved!', 'success'); closeSettings(); })
        .withFailureHandler(function(err) { showToast('Error: ' + err.message, 'error'); })
        .updateUserSettings(settings);
    }
    function showDistrictSummary() {
      google.script.run
        .withSuccessHandler(function(assessments) {
          if (assessments && assessments.length > 0) {
            var target = assessments.find(function(a) { return a.status === 'ready'; }) || assessments[0];
            navigateWithLoading(SCRIPT_URL + '?page=analysis&id=' + target.id + '&tab=district', 'Loading district summary...');
          } else {
            showToast('No assessments available. Upload data first.', 'info');
          }
        })
        .withFailureHandler(function() { showToast('Error loading assessments', 'error'); })
        .getAssessmentList();
    }

    function savePeriods() {
      const periodData = collectPeriodData();
      var btn = event ? event.target.closest('.btn') : null;
      var restore = btn ? setBtnLoading(btn, 'Saving...') : function(){};

      google.script.run
        .withSuccessHandler(function() {
          restore();
          showToast('Class periods saved!', 'success');
          window.location.href = SCRIPT_URL + '?page=analysis&id=' + currentAssessmentId;
        })
        .withFailureHandler(function(error) {
          restore();
          showToast('Error saving periods: ' + error.message, 'error');
        })
        .updateClassPeriods(currentAssessmentId, periodData);
    }
  </script>
</body>
</html>
